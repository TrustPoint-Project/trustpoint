{% extends 'trustpoint/base.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load static %}

{% block content %}
<div class="card card-main" style="display: flex; flex-direction: column; max-height: 85vh;">
    <div class="card-header tp-card-header" style="min-height: 40px;">
        <h1>{% trans 'Devices' %}</h1>
    </div>

    <div class="card-body text-start" style="overflow: auto; flex-grow: 1; max-height: 80%;">
        <button class="btn btn-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#filter-form" aria-expanded="false" aria-controls="filter-form" style="max-width: 150px;">
            {% trans 'Filter' %}
        </button>
        
        <div class="collapse" id="filter-form">
            <form method="get">
                <div class="filter-label">
                    {{ filter.form.device_name.label_tag }}
                </div>
                <div class="filter-dropdown">
                    {{ filter.form.device_name }}
                </div>
                <div class="filter-label">
                    {{ filter.form.device_onboarding_status.label_tag }}
                </div>
                <div class="filter-dropdown">
                    {{ filter.form.device_onboarding_status }}
                </div>
                <div class="filter-label">
                    {{ filter.form.onboarding_protocol.label_tag }}
                </div>
                <div class="filter-dropdown">
                    {{ filter.form.onboarding_protocol }}
                </div>
                <div class="filter-label">
                    {{ filter.form.domain.label_tag }}
                </div>
                <div class="filter-dropdown">
                    {{ filter.form.domain }}
                </div>
                <br>
                <h5>{% trans 'Filter by Tags' %}</h5>
                <div class="filter-tags">
                    {{ filter.form.tags }}
                </div>
                <div>
                    <button type="submit" class="btn btn-primary filter-btn">{% trans 'Filter' %}</button>
                    <a href="{% url 'devices:devices' %}" class="btn btn-secondary filter-btn">{% trans 'Reset' %}</a>
                </div>
            </form>
        </div>
        {% render_table table %}
    </div>
    <div>
        <div class="card-footer d-flex justify-content-between tp-sticky-footer">
            <div>
                <button type="button" class="btn btn-secondary tp-table-select-btn" data-tp-url="delete">{% trans "Delete selected" %}</button>
            </div>
            <div>
                <a class="btn btn-primary" href="{% url 'devices:devices-add' %}">
                    {% trans "Add new Device" %}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal window -->
<div class="modal fade" id="domainModal" tabindex="-1" aria-labelledby="domainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="domainModalLabel">Domain Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Loading...</p>
        </div>
        <div class="modal-footer">
          <select id="certTypeDropdown" class="form-select" style="width: auto; display: inline-block;">
          </select>
          
          <select id="onboardingMethodDropdown" class="form-select" style="width: auto; display: inline-block;">
          </select>
          
          <button id="addCertificateButton" class="btn btn-primary">Add Certificate</button>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
    const domainModal = document.getElementById('domainModal');
    const certTypeDropdown = document.getElementById('certTypeDropdown');
    const onboardingMethodDropdown = document.getElementById('onboardingMethodDropdown');
    const addCertificateButton = document.getElementById('addCertificateButton');
    let domainId = null;

    function loadDropdownOptions() {
        certTypeDropdown.innerHTML = '<option>Loading...</option>';
        onboardingMethodDropdown.innerHTML = '<option>Loading...</option>';

        fetch('/api/devices/certificate-types/')
            .then(response => response.json())
            .then(data => {
                certTypeDropdown.innerHTML = data.types.map(type => `
                    <option value="${type.value}">${type.label}</option>
                `).join('');
            })
            .catch(error => console.error('Error fetching certificate types:', error));

        fetch('/api/devices/onboarding-methods/')
            .then(response => response.json())
            .then(data => {
                onboardingMethodDropdown.innerHTML = data.methods.map(method => `
                    <option value="${method.value}">${method.label}</option>
                `).join('');
            })
            .catch(error => console.error('Error fetching onboarding methods:', error));
    }

    domainModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        domainId = button.getAttribute('data-domain-id');
        deviceId = button.getAttribute('data-device-id');

        loadDropdownOptions();

        const modalBody = domainModal.querySelector('.modal-body');
        modalBody.innerHTML = '<p>Loading certificates...</p>';

        fetch(`/api/devices/domain-certificates/${domainId}/`)
            .then(response => response.json())
            .then(data => {
                modalBody.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Expiration Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.certificates.map(cert => `
                                <tr>
                                    <td>${cert.type}</td>
                                    <td>${cert.expiration_date}</td>
                                    <td>${cert.status}</td>
                                    <td><a href="${cert.revoke_url}" class="btn btn-danger">Revoke</a></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            })
            .catch(error => {
                modalBody.innerHTML = '<p>Error loading certificates. Please try again later.</p>';
                console.error('Error fetching certificates:', error);
            });
    });

    addCertificateButton.addEventListener('click', function () {
        const certType = certTypeDropdown.value;
        const onboardingMethod = onboardingMethodDropdown.value;

        console.log("CertType:", certType);
        console.log("OnboardingMethod:", onboardingMethod);
        console.log("DomainId beim Klick:", domainId);

        if (!certType || !onboardingMethod || !domainId) {
            alert("Fehlende Daten f√ºr die Zertifikatserstellung!");
            return;
        }

        window.location.href = `/onboarding/${deviceId}/${domainId}?certType=${certType}&onboarding=${onboardingMethod}&`;
    });
});
</script>
{% endblock content %}
