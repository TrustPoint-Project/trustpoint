{% extends 'trustpoint/base.html' %} {% block content %} {% include 'home/counts-panel.html' %} {%
include 'home/notifications-tab.html' %} {% include 'home/charts-tab.html' %}

<script>
  var devicesByOSLineChart, devicesByDomainDonutChart, devicesByOPBarChart;
  var certsByStatusLineChart, certsByDomainPieChart, certsByTemplateBarChart;
  var certsByDateStackChart, certsByIssuingCADonutChart, issuingCAsByTypePieChart;

  // Function to fetch dashboard data using backend api
  async function fetchDasbhboardData() {
    try {
      const response = await fetch("/api/home/dashboard_data");
      console.log("res", response);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error("Error fetching device count:", error);
      return null; // Handle the error appropriately
    }
  }

  // Below are the functions to update counts panel

  // Function to update the device counts
  function updateDeviceCounts(deviceCounts) {
    //console.log("deviceCounts", deviceCounts);

    document.getElementById("total-device-count").textContent = `${deviceCounts.total}`;
    document.getElementById("onboared-device-count").textContent = `Onboarded: ${deviceCounts.O}`;
    document.getElementById("pending-device-count").textContent = `Waiting: ${deviceCounts.P}`;
    // Update progress bars
    document.getElementById("onboared-device-progress").style.width = `${
      (deviceCounts.O * 100) / deviceCounts.total
    }%`;
    document.getElementById("pending-device-progress").style.width = `${
      (deviceCounts.P * 100) / deviceCounts.total
    }%`;
  }

  // Function to update the cert counts
  function updateCertCounts(certCounts) {
    //console.log("certCounts", certCounts);
    // update certificate count panel
    document.getElementById("total-cert-count").textContent = `${certCounts.total}`;
    document.getElementById("active-cert-count").textContent = `Active: ${certCounts.active}`;
    document.getElementById("expired-cert-count").textContent = `Expired: ${certCounts.expired}`;
    // Update progress bars
    document.getElementById("active-cert-progress").style.width = `${
      (certCounts.active * 100) / certCounts.total
    }%`;
    document.getElementById("expired-cert-progress").style.width = `${
      (certCounts.expired * 100) / certCounts.total
    }%`;

    // update expiring certificate count panel
    document.getElementById(
      "total-expiring-cert-count"
    ).textContent = `${certCounts.expiring_in_7_days}`;
    document.getElementById(
      "expiring-1day-cert-count"
    ).textContent = `Next 24 hours: ${certCounts.expiring_in_1_day}`;
    document.getElementById(
      "expiring-7days-cert-count"
    ).textContent = `Next 7 days: ${certCounts.expiring_in_7_days}`;
    // Update progress bars
    document.getElementById("expiring-1day-cert-progress").style.width = `${
      (certCounts.expiring_in_1_day * 100) / certCounts.total
    }%`;
    document.getElementById("expiring-7days-cert-progress").style.width = `${
      (certCounts.expiring_in_7_days * 100) / certCounts.total
    }%`;
  }

  // Function to update the issuing ca counts
  function updateIssuingCACounts(issuingCACounts) {
    //console.log("issuingCACounts", issuingCACounts);

    document.getElementById("total-issuing-ca-count").textContent = `${issuingCACounts.total}`;
    document.getElementById(
      "active-issuing-ca-count"
    ).textContent = `Active: ${issuingCACounts.active}`;
    document.getElementById(
      "expired-issuing-ca-count"
    ).textContent = `Expired: ${issuingCACounts.expired}`;
    // Update progress bars
    document.getElementById("active-issuing-ca-progress").style.width = `${
      (issuingCACounts.active * 100) / issuingCACounts.total
    }%`;
    document.getElementById("expired-issuing-ca-progress").style.width = `${
      (issuingCACounts.expired * 100) / issuingCACounts.total
    }%`;
  }

  // Below are the functions to update charts

  // Function to update the issuing ca certificate stack chart
  function updateDeviceDateChart(deviceDateCounts) {
    var devicesByOSLineChartEle = document.getElementById("devicesByOSLineChart").getContext("2d");
    devicesByOSLineChart != undefined ? devicesByOSLineChart.destroy() : "";

    const chartLabels = [...new Set(deviceDateCounts.map((item) => item.issue_date))]; // Unique dates
    const datasets = {};

    // Group data by 'onboarding_status'
    deviceDateCounts.forEach((item) => {
      if (!datasets[item.onboarding_status]) {
        datasets[item.onboarding_status] = {
          label: item.onboarding_status,
          data: Array(chartLabels.length).fill(0), // Initialize count for each date
          //stack: "stack",
          //backgroundColor: getRandomColor(), // Random color for each dataset
        };
      }
      const index = chartLabels.indexOf(item.issue_date);
      datasets[item.onboarding_status].data[index] += item.device_count; // Accumulate counts
    });
    // Convert datasets object to array for Chart.js
    const chartDatasets = Object.values(datasets);
    //console.log("line chart", chartDatasets, chartLabels);
    devicesByOSLineChart = new Chart(devicesByOSLineChartEle, {
      type: "line",
      data: {
        labels: chartLabels,
        datasets: chartDatasets,
      },
      options: {
        scales: {
          y: {
            beginAtZero: "true",
          },
        },
      },
    });
  }

  // Function to update the devices by onboarding protocol line chart
  function updateDeviceByOPLineChart(deviceOPCounts) {
    var devicesByOPBarChartEle = document.getElementById("devicesByOPBarChart").getContext("2d");
    devicesByOPBarChart != undefined ? devicesByOPBarChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    Object.entries(deviceOPCounts).forEach(([key, value]) => {
      chartLabels.push(key);
      chartData.push(value);
    });
    //console.log(chartData, chartLabels);
    devicesByOPBarChart = new Chart(devicesByOPBarChartEle, {
      type: "bar",
      data: {
        labels: chartLabels,
        datasets: [
          {
            label: "Number of Devices",
            data: chartData,
            borderColor: "#0d6efd",
            backgroundColor: "#0d6efd",
            tension: 0.4,
            fill: "true",
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: "true",
          },
        },
      },
    });
  }

  // Function to update the devices by domain donut chart
  function updateDevicesByDomainDonutChart(deviceDomainCounts) {
    var devicesByDomainDonutChartEle = document
      .getElementById("devicesByDomainDonutChart")
      .getContext("2d");
    devicesByDomainDonutChart != undefined ? devicesByDomainDonutChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    deviceDomainCounts.forEach((item) => {
      chartLabels.push(item.unique_name);
      chartData.push(item.device_count);
    });
    //console.log("deviceDomainCounts donut", chartData, chartLabels);
    devicesByDomainDonutChart = new Chart(devicesByDomainDonutChartEle, {
      type: "doughnut",
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartData,
            borderWidth: 1,
            //backgroundColor: ["#0d6efd", "#ffc107", "#d10c15"],
            hoverOffset: 4,
          },
        ],
      },
    });
  }

  // Function to update the certificates by domain pie chart
  function updateCertsByDomainPieChart(certDomainCounts) {
    var certsByDomainPieChartEle = document
      .getElementById("certsByDomainPieChart")
      .getContext("2d");
    certsByDomainPieChart != undefined ? certsByDomainPieChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    certDomainCounts.forEach((item) => {
      chartLabels.push(item.unique_name);
      chartData.push(item.cert_count);
    });
    //console.log("certDomainCounts donut", chartData, chartLabels);
    certsByDomainPieChart = new Chart(certsByDomainPieChartEle, {
      type: "doughnut",
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartData,
            borderWidth: 1,
            //backgroundColor: ["#0d6efd", "#ffc107", "#d10c15"],
            hoverOffset: 4,
          },
        ],
      },
    });
  }

  // Function to update the certy by template bar chart
  function updateCertsByTemplateBarChart(certsByTempateCounts) {
    var certsByTemplateBarChartEle = document
      .getElementById("certsByTemplateBarChart")
      .getContext("2d");
    certsByTemplateBarChart != undefined ? certsByTemplateBarChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    Object.entries(certsByTempateCounts).forEach(([key, value]) => {
      chartLabels.push(key);
      chartData.push(value);
    });
    //console.log(chartData, chartLabels);
    certsByTemplateBarChart = new Chart(certsByTemplateBarChartEle, {
      type: "bar",
      data: {
        labels: chartLabels,
        datasets: [
          {
            label: "Number of Certificates",
            data: chartData,
            borderColor: "#0d6efd",
            backgroundColor: "#0d6efd",
            tension: 0.4,
            fill: "true",
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: "true",
          },
        },
      },
    });
  }

  // Function to update the issuing ca counts
  function updateCertsByIssuingCAChart(certIssuingCACounts) {
    var certsByIssuingCADonutChartEle = document
      .getElementById("certsByIssuingCADonutChart")
      .getContext("2d");
    certsByIssuingCADonutChart != undefined ? certsByIssuingCADonutChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    certIssuingCACounts.forEach((item) => {
      chartLabels.push(item.ca_name);
      chartData.push(item.cert_count);
    });
    //console.log("certIssuingCACounts", chartData, chartLabels);
    certsByIssuingCADonutChart = new Chart(certsByIssuingCADonutChartEle, {
      type: "doughnut",
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartData,
            borderWidth: 1,
            //backgroundColor: ["#0d6efd", "#ffc107", "#d10c15"],
            hoverOffset: 4,
          },
        ],
      },
    });
  }

  // Function to update the issuing ca certificate stack chart
  function updateCertsByDateStackChart(certDateCounts) {
    var certsByDateStackChartEle = document
      .getElementById("certsByDateStackChart")
      .getContext("2d");
    certsByDateStackChart != undefined ? certsByDateStackChart.destroy() : "";

    const chartLabels = [...new Set(certDateCounts.map((item) => item.issue_date))]; // Unique dates
    const datasets = {};

    // Group data by 'name'
    certDateCounts.forEach((item) => {
      if (!datasets[item.name]) {
        datasets[item.name] = {
          label: item.name,
          data: Array(chartLabels.length).fill(0), // Initialize count for each date
          stack: "stack",
          //backgroundColor: getRandomColor(), // Random color for each dataset
        };
      }
      const index = chartLabels.indexOf(item.issue_date);
      datasets[item.name].data[index] += item.cert_count; // Accumulate counts
    });
    // Convert datasets object to array for Chart.js
    const chartDatasets = Object.values(datasets);
    //console.log("stacked chart", chartDatasets);
    certsByDateStackChart = new Chart(certsByDateStackChartEle, {
      type: "bar",
      data: {
        labels: chartLabels,
        datasets: chartDatasets,
      },
      options: {
        scales: {
          y: {
            beginAtZero: "true",
          },
        },
      },
    });
  }

  // Function to update the issuing ca pie chart
  function updateIssuingCAsByTypePieChart(issuingCaTypeCounts) {
    var issuingCAsByTypePieChartEle = document
      .getElementById("issuingCAsByTypePieChart")
      .getContext("2d");
    issuingCAsByTypePieChart != undefined ? issuingCAsByTypePieChart.destroy() : "";
    var chartLabels = [];
    var chartData = [];
    Object.entries(issuingCaTypeCounts).forEach(([key, value]) => {
      chartLabels.push(key);
      chartData.push(value);
    });
    //console.log("issuingCaTypeCounts", chartData, chartLabels);
    issuingCAsByTypePieChart = new Chart(issuingCAsByTypePieChartEle, {
      type: "pie",
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartData,
            borderWidth: 1,
            //backgroundColor: ["#0d6efd", "#ffc107", "#d10c15"],
            hoverOffset: 4,
          },
        ],
      },
    });
  }

  // Function to dashboard data
  async function fetchAndUpdateDashboardData() {
    const dashboardData = await fetchDasbhboardData();
    console.log("dashboardData", dashboardData);
    if (dashboardData) {
      if ("device_counts" in dashboardData) {
        updateDeviceCounts(dashboardData.device_counts);
      }
      if ("cert_counts" in dashboardData) {
        updateCertCounts(dashboardData.cert_counts);
      }
      if ("iussuing_ca_counts" in dashboardData) {
        updateIssuingCACounts(dashboardData.iussuing_ca_counts);
      }
      if ("device_counts_by_date_and_os" in dashboardData) {
        updateDeviceDateChart(dashboardData.device_counts_by_date_and_os);
      }
      if ("device_counts_by_op" in dashboardData) {
        updateDeviceByOPLineChart(dashboardData.device_counts_by_op);
      }
      if ("device_counts_by_domain" in dashboardData) {
        updateDevicesByDomainDonutChart(dashboardData.device_counts_by_domain);
      }
      if ("cert_counts_by_issuing_ca" in dashboardData) {
        updateCertsByIssuingCAChart(dashboardData.cert_counts_by_issuing_ca);
      }
      if ("cert_counts_by_issuing_ca_and_date" in dashboardData) {
        updateCertsByDateStackChart(dashboardData.cert_counts_by_issuing_ca_and_date);
      }
      if ("cert_counts_by_domain" in dashboardData) {
        updateCertsByDomainPieChart(dashboardData.cert_counts_by_domain);
      }
      if ("cert_counts_by_template" in dashboardData) {
        updateCertsByTemplateBarChart(dashboardData.cert_counts_by_template);
      }
      if ("ca_counts_by_type" in dashboardData) {
        updateIssuingCAsByTypePieChart(dashboardData.ca_counts_by_type);
      }
    }
  }

  // Call the function to fetch and display dashboard data
  fetchAndUpdateDashboardData();
  // every 20 seconds
  //setInterval(fetchAndUpdateDashboardData, 1000*20);

  document.addEventListener("DOMContentLoaded", function () {
    //device charts data from context
    var stackChartConfig = JSON.parse("{{ line_chart_device_config|escapejs }}");
    var donutChartDeviceConfig = JSON.parse("{{ donut_chart_device_config|escapejs }}");
    var barChartDeviceConfig = JSON.parse("{{ bar_chart_device_config|escapejs }}");

    //cert charts data from context
    var lineChartCertConfig = JSON.parse("{{ line_chart_cert_config|escapejs }}");
    var donutChartCertConfig = JSON.parse("{{ donut_chart_cert_config|escapejs }}");
    var barChartCertConfig = JSON.parse("{{ bar_chart_cert_config|escapejs }}");

    //CA charts data from context
    var barChartCAConfig = JSON.parse("{{ bar_chart_ca_config|escapejs }}");
    var lineChartConfig = JSON.parse("{{ line_chart_config|escapejs }}");
    var donutChartCAConfig = JSON.parse("{{ donut_chart_ca_config|escapejs }}");

    var chartTabEl = document.getElementById("chartTabs");
    var chartTab = new bootstrap.Tab(chartTabEl);
    // Initial update for the active chart tab
    var activeChartTabId = document
      .querySelector("#chartTabs .nav-link.active")
      .getAttribute("href")
      .substring(1);
    updateChartContent(activeChartTabId);

    // Add event listener to the charts tab for the 'shown.bs.tab' event
    chartTabEl.addEventListener("shown.bs.tab", function (event) {
      var targetId = event.target.getAttribute("href").substring(1);
      updateChartContent(targetId);
    });

    // function to update charts content based on chart tab id
    function updateChartContent(chartTabId) {
      //console.log("chartTabId", chartTabId);
      if (chartTabId == "deviceChartTab") {
        //var lineChartDeviceEle = document.getElementById("devicesByOSLineChart").getContext("2d");
        //((if (!devicesByOSLineChart) devicesByOSLineChart = new Chart(lineChartDeviceEle, stackChartConfig);
        //var donutChartDeviceEle = document.getElementById("devicesByDomainDonutChart").getContext("2d");
        //if (!devicesByDomainDonutChart)
        //  devicesByDomainDonutChart = new Chart(donutChartDeviceEle, donutChartDeviceConfig);
        //var barChartDeviceEle = document.getElementById("devicesByOPBarChart").getContext("2d");
        //if (!devicesByOPBarChart) devicesByOPBarChart = new Chart(barChartDeviceEle, barChartDeviceConfig);
      } else if (chartTabId == "certChartTab") {
        var certsByStatusLineChartEle = document
          .getElementById("certsByStatusLineChart")
          .getContext("2d");
        if (!certsByStatusLineChart)
          certsByStatusLineChart = new Chart(certsByStatusLineChartEle, lineChartCertConfig);

        //var donutChartCertEle = document.getElementById("certsByDomainPieChart").getContext("2d");
        //if (!certsByDomainPieChart) certsByDomainPieChart = new Chart(donutChartCertEle, donutChartCertConfig);

        //var barChartCertEle = document.getElementById("barChartCert").getContext("2d");
        //if (!barChartCert) barChartCert = new Chart(barChartCertEle, barChartCertConfig);
      } else if (chartTabId == "caChartTab") {
        // var lineChartEle = document.getElementById("lineChart").getContext("2d");
        // if(!lineChart)
        //   lineChart = new Chart(lineChartEle, lineChartConfig);
        //var barChartCAEle = document.getElementById("barChartCA").getContext("2d");
        //if (!barChartCA) barChartCA = new Chart(barChartCAEle, barChartCAConfig);
        //var donutChartCAEle = document.getElementById("donutChartCA").getContext("2d");
        //if (!donutChartCA) donutChartCA = new Chart(donutChartCAEle, donutChartCAConfig);
      }
    }
  });
</script>

{% endblock content %}
